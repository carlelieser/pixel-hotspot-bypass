# KernelSU-Next Version Fix for Bazel Sandbox
#
# Problem: Bazel's sandbox doesn't include .git directory, causing
# KernelSU's git-based version detection to fail.
#
# Solution: Hardcode version at the beginning of the Makefile and
# disable the dynamic version detection.
#
# Apply with: patch -p1 < kernelsu-version-fix.patch
# From the kernel source root directory.

--- a/drivers/kernelsu/kernel/Makefile
+++ b/drivers/kernelsu/kernel/Makefile
@@ -1,3 +1,6 @@
+ccflags-y += -DKSU_VERSION=12882
+ccflags-y += -DKSU_VERSION_TAG=\"v1.1.1\"
+
 kernelsu-objs := ksu.o
 kernelsu-objs += allowlist.o
 kernelsu-objs += apk_sign.o
@@ -21,10 +24,10 @@ endif
 KSU_VERSION_TAG := $(shell git describe --tags --always --dirty 2>/dev/null)

 ifneq ($(KSU_VERSION_TAG),)
-ccflags-y += -DKSU_VERSION_TAG=\"$(KSU_VERSION_TAG)\"
+#DISABLED ccflags-y += -DKSU_VERSION_TAG=\"$(KSU_VERSION_TAG)\"
 else
 $(warning KSU_VERSION_TAG is not set)
-ccflags-y += -DKSU_VERSION_TAG=\"v0.0.0\"
+#DISABLED ccflags-y += -DKSU_VERSION_TAG=\"v0.0.0\"
 endif

 # KSU_VERSION = 10000 + commits + 200
@@ -34,10 +37,10 @@ else
 endif

 ifneq ($(KSU_VERSION),)
-ccflags-y += -DKSU_VERSION=$(KSU_VERSION)
+#DISABLED ccflags-y += -DKSU_VERSION=$(KSU_VERSION)
 else
 $(warning KSU_VERSION is not set, use default value)
-ccflags-y += -DKSU_VERSION=12882
+#DISABLED ccflags-y += -DKSU_VERSION=12882
 endif

 obj-$(CONFIG_KSU) += kernelsu.o
